name: Auto-Register Terraform Modules

# This workflow automatically registers Terraform modules when changes are detected
# Uses the latest Lace CLI with improved error handling and verification

# Trigger when changes are pushed to main branch in the modules directory
on:
  push:
    branches:
      - main
    paths:
      - 'modules/**'

# Ensure only one registration runs at a time
concurrency:
  group: terraform-registry-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-and-register-modules:
    name: Detect and Register Modified Modules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits to detect changes

      - name: Detect modified modules
        id: detect-modules
        run: |
          echo "Detecting modified modules..."

          # Get list of added/modified files (exclude deletions)
          changed_files=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '^modules/' || true)

          if [ -z "$changed_files" ]; then
            echo "No module changes detected"
            echo "modules_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Extract unique module directories (format: modules/aws-s3-bucket)
          module_dirs=$(echo "$changed_files" | cut -d'/' -f1,2 | sort -u)

          echo "Modified modules:"
          echo "$module_dirs"

          # Convert to JSON array for matrix strategy
          modules_json=$(echo "$module_dirs" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "modules_json=$modules_json" >> $GITHUB_OUTPUT
          echo "modules_found=true" >> $GITHUB_OUTPUT

      - name: Display detected modules
        if: steps.detect-modules.outputs.modules_found == 'true'
        run: |
          echo "The following modules will be registered:"
          echo '${{ steps.detect-modules.outputs.modules_json }}' | jq -r '.[]'

    outputs:
      modules_json: ${{ steps.detect-modules.outputs.modules_json }}
      modules_found: ${{ steps.detect-modules.outputs.modules_found }}

  register-modules:
    name: Register Module
    runs-on: ubuntu-latest
    needs: detect-and-register-modules
    if: needs.detect-and-register-modules.outputs.modules_found == 'true'

    strategy:
      matrix:
        module_path: ${{ fromJson(needs.detect-and-register-modules.outputs.modules_json) }}
      fail-fast: false  # Continue registering other modules even if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate module structure
        id: validate
        run: |
          MODULE_PATH="${{ matrix.module_path }}"

          echo "ðŸ“‹ Validating module structure at: $MODULE_PATH"

          # Check if module.yaml exists
          if [ ! -f "$MODULE_PATH/module.yaml" ]; then
            echo "âŒ ERROR: module.yaml not found in $MODULE_PATH"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if main.tf exists
          if [ ! -f "$MODULE_PATH/main.tf" ]; then
            echo "âŒ ERROR: main.tf not found in $MODULE_PATH"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… Module structure is valid"
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Lace CLI
        run: |
          echo "ðŸ“¥ Downloading Lace CLI..."

          # Download from Lace releases server
          wget -q https://releases.lace.cloud/lace-cli-linux-amd64 -O lace

          # Make executable and move to PATH
          chmod +x lace
          sudo mv lace /usr/local/bin/lace

          # Verify installation
          echo "âœ… Lace CLI installed successfully"
          lace --version || echo "Lace CLI ready"

      - name: Terraform Format Check
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸŽ¨ Checking Terraform formatting..."

          # Check if Terraform files are properly formatted
          lace terraform fmt --check --path "$MODULE_PATH"

          echo "âœ… Terraform files are properly formatted"

      - name: Terraform Validate
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸ” Validating Terraform configuration..."

          # Validate Terraform syntax and configuration
          lace terraform validate --path "$MODULE_PATH"

          echo "âœ… Terraform configuration is valid"

      - name: Terraform Security Scan (Optional)
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸ”’ Running security scan..."

          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          sudo mv tfsec /usr/local/bin/ 2>/dev/null || true

          # Run security scan with soft-fail (won't block registration)
          lace terraform scan --path "$MODULE_PATH" --soft-fail || echo "âš ï¸  Security scan completed with warnings"

          echo "âœ… Security scan complete"
        continue-on-error: true

      - name: Authenticate with Lace
        env:
          # Use GitHub token for authentication
          # This token should be stored as a repository secret: LACE_GITHUB_TOKEN
          # It should be a GitHub Personal Access Token with read:user and user:email scopes
          GITHUB_TOKEN: ${{ secrets.LACE_GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Authenticating with Lace platform..."

          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ ERROR: LACE_GITHUB_TOKEN secret not set"
            echo "Please add LACE_GITHUB_TOKEN to repository secrets"
            exit 1
          fi

          # Authenticate CLI (exchanges GitHub token for Lace API key)
          lace login --token "$GITHUB_TOKEN"

          # Verify authentication
          echo "âœ… Authentication successful"
          lace whoami

      - name: Register module with Lace
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸ“¦ Registering module: $MODULE_PATH"
          echo ""

          # Register module with explicit git context
          lace terraform-registry register \
            --module-path "$MODULE_PATH" \
            --commit-sha "${{ github.sha }}" \
            --ref "${{ github.ref }}" \
            --actor "${{ github.actor }}"

          echo ""
          echo "âœ… Module registration complete"

      - name: Verify registration
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸ” Verifying module registration..."

          # Extract module name and system from module.yaml
          MODULE_NAME=$(grep -A 1 "^module:" "$MODULE_PATH/module.yaml" | grep "name:" | cut -d':' -f2 | tr -d ' ')
          MODULE_SYSTEM=$(grep -A 2 "^module:" "$MODULE_PATH/module.yaml" | grep "system:" | cut -d':' -f2 | tr -d ' ')

          echo "Module: $MODULE_SYSTEM/$MODULE_NAME"

          # List module versions to verify
          lace terraform-registry get "$MODULE_NAME" "$MODULE_SYSTEM"

          echo "âœ… Module verified in registry"

      - name: Cleanup credentials
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up credentials..."
          lace logout || true
          rm -rf ~/.config/lace || true

  summary:
    name: Registration Summary
    runs-on: ubuntu-latest
    needs: [detect-and-register-modules, register-modules]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Terraform Module Registration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-and-register-modules.outputs.modules_found }}" == "true" ]; then
            echo "## âœ… Registration completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Modified modules:" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.detect-and-register-modules.outputs.modules_json }}' | jq -r '.[] | "- " + .' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "Ref: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ No module changes detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No modules were modified in this commit." >> $GITHUB_STEP_SUMMARY
          fi
