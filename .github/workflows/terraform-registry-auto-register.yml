name: Auto-Register Terraform Modules

# This workflow automatically registers Terraform modules when changes are detected
# Uses the latest Lace CLI with improved error handling and verification

# Trigger when changes are pushed to main branch in the modules directory
on:
  push:
    branches:
      - main
    paths:
      - 'modules/**'

# Ensure only one registration runs at a time
concurrency:
  group: terraform-registry-${{ github.ref }}
  cancel-in-progress: false

jobs:
  detect-and-register-modules:
    name: Detect and Register Modified Modules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Fetch last 2 commits to detect changes

      - name: Detect modified modules
        id: detect-modules
        run: |
          echo "Detecting modified modules..."

          # Get list of added/modified files (exclude deletions)
          changed_files=$(git diff --name-only --diff-filter=AM HEAD^ HEAD | grep '^modules/' || true)

          if [ -z "$changed_files" ]; then
            echo "No module changes detected"
            echo "modules_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "$changed_files"

          # Function to find module root (directory containing module.yaml)
          find_module_root() {
            local path="$1"
            local dir=$(dirname "$path")
            
            # Walk up until we find module.yaml or traverse out of modules/
            while [ "$dir" != "." ] && [ "$dir" != "/" ]; do
              if [ -f "$dir/module.yaml" ]; then
                echo "$dir"
                return 0
              fi
              # Stop if we went up to the parent of modules directory
              if [ "$dir" == "." ] || [ "$dir" == "modules" ]; then
                return 1
              fi
              dir=$(dirname "$dir")
            done
            return 1
          }

          # Find unique module directories
          module_dirs=""
          skipped_files=""
          for file in $changed_files; do
            if module_root=$(find_module_root "$file"); then
              module_dirs="$module_dirs$module_root"$'\n'
            else
              skipped_files="$skipped_files$file"$'\n'
            fi
          done

          # Warn about files not part of any module
          if [ -n "$skipped_files" ]; then
            echo "::warning::Changed files not part of any module (no module.yaml found):"
            echo "$skipped_files" | sed '/^$/d' | while read -r f; do echo "  - $f"; done
          fi

          # Sort unique
          unique_modules=$(echo "$module_dirs" | sort -u | sed '/^$/d')

          echo "Modified modules:"
          echo "$unique_modules"

          if [ -z "$unique_modules" ]; then
             echo "No valid modules found in modified files (module.yaml missing)"
             echo "modules_found=false" >> $GITHUB_OUTPUT
             exit 0
          fi

          # Convert to JSON array for matrix strategy
          modules_json=$(echo "$unique_modules" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "modules_json=$modules_json" >> $GITHUB_OUTPUT
          echo "modules_found=true" >> $GITHUB_OUTPUT

      - name: Display detected modules
        if: steps.detect-modules.outputs.modules_found == 'true'
        run: |
          echo "The following modules will be registered:"
          echo '${{ steps.detect-modules.outputs.modules_json }}' | jq -r '.[]'

    outputs:
      modules_json: ${{ steps.detect-modules.outputs.modules_json }}
      modules_found: ${{ steps.detect-modules.outputs.modules_found }}

  register-modules:
    name: Register Module
    runs-on: ubuntu-latest
    needs: detect-and-register-modules
    if: needs.detect-and-register-modules.outputs.modules_found == 'true'

    strategy:
      matrix:
        module_path: ${{ fromJson(needs.detect-and-register-modules.outputs.modules_json) }}
      fail-fast: false  # Continue registering other modules even if one fails

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate module structure
        id: validate
        run: |
          MODULE_PATH="${{ matrix.module_path }}"

          echo "ðŸ“‹ Validating module structure at: $MODULE_PATH"

          # Check if module.yaml exists
          if [ ! -f "$MODULE_PATH/module.yaml" ]; then
            echo "âŒ ERROR: module.yaml not found in $MODULE_PATH"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Check if main.tf exists
          if [ ! -f "$MODULE_PATH/main.tf" ]; then
            echo "âŒ ERROR: main.tf not found in $MODULE_PATH"
            echo "valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… Module structure is valid"
          echo "valid=true" >> $GITHUB_OUTPUT

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Lace CLI
        run: |
          echo "ðŸ“¥ Downloading Lace CLI..."

          # Download from Lace releases server
          wget -q https://releases.lace.cloud/lace-cli-linux-amd64 -O lace

          # Make executable and move to PATH
          chmod +x lace
          sudo mv lace /usr/local/bin/lace

          # Verify installation
          echo "âœ… Lace CLI installed successfully"
          lace --version || echo "Lace CLI ready"

      - name: Terraform Format Check
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸŽ¨ Checking Terraform formatting..."

          # Check if Terraform files are properly formatted
          lace terraform fmt --check --path "$MODULE_PATH"

          echo "âœ… Terraform files are properly formatted"

      - name: Terraform Validate
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸ” Validating Terraform configuration..."
          lace terraform validate --path "$MODULE_PATH"
          echo "âœ… Terraform configuration is valid"

      - name: Terraform Security Scan (Optional)
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "ðŸ”’ Running security scan..."

          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          sudo mv tfsec /usr/local/bin/ 2>/dev/null || true

          # Run security scan with soft-fail (won't block registration)
          lace terraform scan --path "$MODULE_PATH" --soft-fail || echo "âš ï¸  Security scan completed with warnings"

          echo "âœ… Security scan complete"
        continue-on-error: true

      - name: Authenticate with Lace
        env:
          LACE_API_KEY: ${{ secrets.LACE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "ðŸ” Authenticating with Lace platform..."

          if [ -z "$LACE_API_KEY" ]; then
            echo "âŒ ERROR: LACE_SERVICE_ACCOUNT_KEY secret not set"
            echo "Please add LACE_SERVICE_ACCOUNT_KEY to repository secrets"
            exit 1
          fi

          # Verify authentication (LACE_API_KEY is read automatically by the CLI)
          echo "âœ… Authentication successful"
          lace whoami

      - name: Register module with Lace
        env:
          MODULE_PATH: ${{ matrix.module_path }}
          LACE_API_KEY: ${{ secrets.LACE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "ðŸ“¦ Registering module: $MODULE_PATH"
          echo ""

          # Register module with explicit git context
          # No --organization needed: service account is allowed to publish public modules
          lace terraform-registry register \
            --module-path "$MODULE_PATH" \
            --commit-sha "${{ github.sha }}" \
            --ref "${{ github.ref }}" \
            --actor "${{ github.actor }}"

          echo ""
          echo "âœ… Module registration complete"

      - name: Verify registration
        env:
          MODULE_PATH: ${{ matrix.module_path }}
          LACE_API_KEY: ${{ secrets.LACE_SERVICE_ACCOUNT_KEY }}
        run: |
          echo "ðŸ” Verifying module registration..."

          # Extract module name and system from module.yaml
          MODULE_NAME=$(grep -A 1 "^module:" "$MODULE_PATH/module.yaml" | grep "name:" | cut -d':' -f2 | tr -d ' ')
          MODULE_SYSTEM=$(grep -A 2 "^module:" "$MODULE_PATH/module.yaml" | grep "system:" | cut -d':' -f2 | tr -d ' ')

          echo "Module: $MODULE_SYSTEM/$MODULE_NAME"

          # List module versions to verify
          lace terraform-registry get "$MODULE_NAME" "$MODULE_SYSTEM"

          echo "âœ… Module verified in registry"

      - name: Cleanup credentials
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up..."
          # No credentials file to clean â€” LACE_API_KEY env var is ephemeral

  summary:
    name: Registration Summary
    runs-on: ubuntu-latest
    needs: [detect-and-register-modules, register-modules]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Terraform Module Registration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-and-register-modules.outputs.modules_found }}" == "true" ]; then
            echo "## âœ… Registration completed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Modified modules:" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.detect-and-register-modules.outputs.modules_json }}' | jq -r '.[] | "- " + .' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Commit: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
            echo "Ref: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ No module changes detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "No modules were modified in this commit." >> $GITHUB_STEP_SUMMARY
          fi
