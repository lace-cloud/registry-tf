name: PR Validate Modules

# Validates Terraform modules on PRs targeting develop
# No authentication needed — all validation is local/read-only

on:
  pull_request:
    branches:
      - develop
      - main
    paths:
      - 'modules/**'

concurrency:
  group: pr-validate-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  detect-changed-modules:
    name: Detect Changed Modules
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Detect changed module files
        id: changed-files
        uses: tj-actions/changed-files@v45
        with:
          files: modules/**

      - name: Find module roots
        id: find-modules
        run: |
          if [ "${{ steps.changed-files.outputs.any_changed }}" != "true" ]; then
            echo "No module changes detected"
            echo "modules_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed files:"
          echo "${{ steps.changed-files.outputs.all_changed_files }}"

          # Function to find module root (directory containing module.yaml)
          find_module_root() {
            local path="$1"
            local dir=$(dirname "$path")

            while [ "$dir" != "." ] && [ "$dir" != "/" ]; do
              if [ -f "$dir/module.yaml" ]; then
                echo "$dir"
                return 0
              fi
              if [ "$dir" == "modules" ]; then
                return 1
              fi
              dir=$(dirname "$dir")
            done
            return 1
          }

          # Find unique module directories
          module_dirs=""
          skipped_files=""
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            if module_root=$(find_module_root "$file"); then
              module_dirs="$module_dirs$module_root"$'\n'
            else
              skipped_files="$skipped_files$file"$'\n'
            fi
          done

          # Fail if any changed files are not part of a module
          if [ -n "$skipped_files" ]; then
            echo "::error::Changed files not part of any module (no module.yaml found):"
            echo "$skipped_files" | sed '/^$/d' | while read -r f; do echo "  - $f"; done
            echo "Each module directory must contain a module.yaml file."
            exit 1
          fi

          # Sort unique
          unique_modules=$(echo "$module_dirs" | sort -u | sed '/^$/d')

          if [ -z "$unique_modules" ]; then
            echo "No valid modules found in changed files"
            echo "modules_found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Changed modules:"
          echo "$unique_modules"

          # Convert to JSON array for matrix strategy
          modules_json=$(echo "$unique_modules" | jq -R -s -c 'split("\n") | map(select(length > 0))')
          echo "modules_json=$modules_json" >> $GITHUB_OUTPUT
          echo "modules_found=true" >> $GITHUB_OUTPUT

    outputs:
      modules_json: ${{ steps.find-modules.outputs.modules_json }}
      modules_found: ${{ steps.find-modules.outputs.modules_found }}

  validate-module:
    name: Validate Module
    runs-on: ubuntu-latest
    needs: detect-changed-modules
    if: needs.detect-changed-modules.outputs.modules_found == 'true'

    strategy:
      matrix:
        module_path: ${{ fromJson(needs.detect-changed-modules.outputs.modules_json) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate module structure
        run: |
          MODULE_PATH="${{ matrix.module_path }}"

          echo "Validating module structure at: $MODULE_PATH"

          if [ ! -f "$MODULE_PATH/module.yaml" ]; then
            echo "ERROR: module.yaml not found in $MODULE_PATH"
            exit 1
          fi

          if [ ! -f "$MODULE_PATH/main.tf" ]; then
            echo "ERROR: main.tf not found in $MODULE_PATH"
            exit 1
          fi

          echo "Module structure is valid"

      - name: Check module_id uniqueness
        run: |
          MODULE_PATH="${{ matrix.module_path }}"
          CURRENT_ID=$(grep "^id:" "$MODULE_PATH/module.yaml" | head -1 | awk '{print $2}')

          if [ -z "$CURRENT_ID" ]; then
            echo "::error::No 'id' field found in $MODULE_PATH/module.yaml"
            exit 1
          fi

          echo "Module id: $CURRENT_ID"

          # Search all module.yaml files for the same id
          DUPLICATES=""
          while IFS= read -r yaml_file; do
            yaml_dir=$(dirname "$yaml_file")
            if [ "$yaml_dir" = "$MODULE_PATH" ]; then
              continue
            fi
            FILE_ID=$(grep "^id:" "$yaml_file" | head -1 | awk '{print $2}')
            if [ "$FILE_ID" = "$CURRENT_ID" ]; then
              DUPLICATES="$DUPLICATES$yaml_dir"$'\n'
            fi
          done < <(find modules -name "module.yaml" -type f)

          if [ -n "$DUPLICATES" ]; then
            echo "::error::Duplicate module_id '$CURRENT_ID' found in other modules:"
            echo "$DUPLICATES" | sed '/^$/d' | while read -r d; do echo "  - $d"; done
            echo "Each module must have a unique id."
            exit 1
          fi

          echo "Module id is unique"

      - name: Check version bump
        run: |
          MODULE_PATH="${{ matrix.module_path }}"
          CURRENT_VERSION=$(grep "^version:" "$MODULE_PATH/module.yaml" | head -1 | awk '{print $2}')

          if [ -z "$CURRENT_VERSION" ]; then
            echo "::error::No 'version' field found in $MODULE_PATH/module.yaml"
            exit 1
          fi

          echo "Current version: $CURRENT_VERSION"

          # Fetch the base branch version
          BASE_VERSION=$(git show origin/${{ github.event.pull_request.base.ref }}:"$MODULE_PATH/module.yaml" 2>/dev/null | grep "^version:" | head -1 | awk '{print $2}' || echo "")

          if [ -z "$BASE_VERSION" ]; then
            echo "New module (not on base branch) — skipping version bump check"
          elif [ "$CURRENT_VERSION" = "$BASE_VERSION" ]; then
            echo "::error::Module version not bumped. Current: $CURRENT_VERSION. Please update the version in $MODULE_PATH/module.yaml."
            exit 1
          else
            echo "Version bumped: $BASE_VERSION -> $CURRENT_VERSION"
          fi

      - name: Install Lace CLI
        run: |
          wget -q https://releases.lace.cloud/lace-cli-linux-amd64 -O lace
          chmod +x lace
          sudo mv lace /usr/local/bin/lace
          lace --version || echo "Lace CLI ready"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Terraform Format Check
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "Checking Terraform formatting..."
          lace terraform fmt --check --path "$MODULE_PATH"
          echo "Terraform files are properly formatted"

      - name: Terraform Validate
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "Validating Terraform configuration..."
          lace terraform validate --path "$MODULE_PATH"
          echo "Terraform configuration is valid"

      - name: Terraform Security Scan (Informational)
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "Running security scan..."
          lace terraform scan --path "$MODULE_PATH" --soft-fail || echo "Security scan completed with warnings"
        continue-on-error: true

      - name: Parse Module
        env:
          MODULE_PATH: ${{ matrix.module_path }}
        run: |
          echo "Parsing module definition..."
          lace module parse --path "$MODULE_PATH"
          echo "Module parsed successfully"

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [detect-changed-modules, validate-module]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Terraform Module Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.detect-changed-modules.outputs.modules_found }}" == "true" ]; then
            echo "## Modules Validated" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '${{ needs.detect-changed-modules.outputs.modules_json }}' | jq -r '.[] | "- `" + . + "`"' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "${{ needs.validate-module.result }}" == "success" ]; then
              echo "**Result:** All modules passed validation" >> $GITHUB_STEP_SUMMARY
            elif [ "${{ needs.validate-module.result }}" == "failure" ]; then
              echo "**Result:** One or more modules failed validation" >> $GITHUB_STEP_SUMMARY
            else
              echo "**Result:** Validation status: ${{ needs.validate-module.result }}" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No module changes detected in this PR." >> $GITHUB_STEP_SUMMARY
          fi
