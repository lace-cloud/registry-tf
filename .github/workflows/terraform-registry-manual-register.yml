name: Manual Module Registration

# This workflow allows manual registration of Terraform modules
# Uses the latest Lace CLI with improved error handling and verification

# Manually trigger module registration via workflow_dispatch
on:
  workflow_dispatch:
    inputs:
      module_path:
        description: 'Path to module directory (e.g., modules/aws-s3-bucket)'
        required: true
        type: string
      force_register:
        description: 'Force registration even if module exists'
        required: false
        type: boolean
        default: false

jobs:
  register-module:
    name: Register Terraform Module
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Display registration details
        run: |
          echo "## Module Registration Request" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Module Path**: \`${{ inputs.module_path }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref**: \`${{ github.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor**: @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Force**: ${{ inputs.force_register }}" >> $GITHUB_STEP_SUMMARY

      - name: Validate module structure
        run: |
          MODULE_PATH="${{ inputs.module_path }}"

          echo "ðŸ“‹ Validating module structure..."

          # Check if path exists
          if [ ! -d "$MODULE_PATH" ]; then
            echo "âŒ ERROR: Directory not found: $MODULE_PATH"
            exit 1
          fi

          # Check required files
          if [ ! -f "$MODULE_PATH/module.yaml" ]; then
            echo "âŒ ERROR: module.yaml not found"
            exit 1
          fi

          if [ ! -f "$MODULE_PATH/main.tf" ]; then
            echo "âŒ ERROR: main.tf not found"
            exit 1
          fi

          # Display module info
          echo "âœ… Module structure is valid"
          echo ""
          echo "Module files found:"
          ls -la "$MODULE_PATH"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Install Lace CLI
        run: |
          echo "ðŸ“¥ Downloading Lace CLI..."

          # Download from Lace releases server
          wget -q https://releases.lace.cloud/lace-cli-linux-amd64 -O lace

          # Make executable and move to PATH
          chmod +x lace
          sudo mv lace /usr/local/bin/lace

          # Verify installation
          echo "âœ… Lace CLI installed successfully"
          lace --version || echo "Lace CLI ready"

      - name: Terraform Format Check
        run: |
          echo "ðŸŽ¨ Checking Terraform formatting..."

          # Check if Terraform files are properly formatted
          lace terraform fmt --check --path "${{ inputs.module_path }}"

          echo "âœ… Terraform files are properly formatted"

      - name: Terraform Validate
        run: |
          echo "ðŸ” Validating Terraform configuration..."

          # Validate Terraform syntax and configuration
          lace terraform validate --path "${{ inputs.module_path }}"

          echo "âœ… Terraform configuration is valid"

      - name: Terraform Security Scan (Optional)
        run: |
          echo "ðŸ”’ Running security scan..."

          # Install tfsec
          curl -s https://raw.githubusercontent.com/aquasecurity/tfsec/master/scripts/install_linux.sh | bash
          sudo mv tfsec /usr/local/bin/ 2>/dev/null || true

          # Run security scan with soft-fail (won't block registration)
          lace terraform scan --path "${{ inputs.module_path }}" --soft-fail || echo "âš ï¸  Security scan completed with warnings"

          echo "âœ… Security scan complete"
        continue-on-error: true

      - name: Authenticate with Lace
        env:
          GITHUB_TOKEN: ${{ secrets.LACE_GITHUB_TOKEN }}
        run: |
          echo "ðŸ” Authenticating..."

          if [ -z "$GITHUB_TOKEN" ]; then
            echo "âŒ ERROR: LACE_GITHUB_TOKEN secret not set"
            echo "Please add LACE_GITHUB_TOKEN to repository secrets"
            exit 1
          fi

          lace login --token "$GITHUB_TOKEN"
          lace whoami

      - name: Register module
        run: |
          echo "ðŸ“¦ Registering module..."
          echo ""

          # Register module with explicit git context
          lace terraform-registry register \
            --module-path "${{ inputs.module_path }}" \
            --organization "lace" \
            --commit-sha "${{ github.sha }}" \
            --ref "${{ github.ref }}" \
            --actor "${{ github.actor }}"

          echo ""
          echo "âœ… Module registration complete"

      - name: Verify registration
        run: |
          MODULE_PATH="${{ inputs.module_path }}"
          MODULE_NAME=$(grep -A 1 "^module:" "$MODULE_PATH/module.yaml" | grep "name:" | cut -d':' -f2 | tr -d ' ')
          MODULE_SYSTEM=$(grep -A 2 "^module:" "$MODULE_PATH/module.yaml" | grep "system:" | cut -d':' -f2 | tr -d ' ')

          echo "ðŸ” Verifying: $MODULE_SYSTEM/$MODULE_NAME"
          lace terraform-registry get "$MODULE_NAME" "$MODULE_SYSTEM"

      - name: Cleanup
        if: always()
        run: |
          lace logout || true
          rm -rf ~/.config/lace || true

      - name: Summary
        if: success()
        run: |
          echo "## âœ… Registration Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Module has been successfully registered in the Lace registry." >> $GITHUB_STEP_SUMMARY
